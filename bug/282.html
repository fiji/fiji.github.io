<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                      "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
  <head>
    <title>Bug 282 &ndash; When quitting, Fiji does not prompt to save changes in non-image windows</title>

      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">


<link rel="Top" href="">

  


  
    
      

      
      



    
    <link href="../css/global.css"
          rel="alternate stylesheet" 
          title="Classic"><link href="../css/global.css" rel="stylesheet"
        type="text/css" ><link href="../css/bug.css" rel="stylesheet"
        type="text/css" >

    <link href="../css/dusk.css" rel="stylesheet"
        type="text/css" title="Dusk">

    

    

    


    


    

    
    
    
  </head>



  <body onload=""
        class=" bz_bug bz_status_RESOLVED bz_product_Fiji bz_component_ImageJ1 bz_bug_282 yui-skin-sam">



<div id="header">
<div id="banner">
  </div>

<table border="0" cellspacing="0" cellpadding="0" id="titles">
<tr>
    <td id="title">
      <p>Bugzilla &ndash; Bug&nbsp;282</p>
    </td>

    <td id="subtitle">
      <p class="subheader">When quitting, Fiji does not prompt to save changes in non-image windows</p>
    </td>

    <td id="information">
      <p class="header_addl_info">Last modified: 2011-03-23 15:00:43 CDT</p>
    </td>
</tr>
</table>


</div> 

<div id="bugzilla-body">


<form name="changeform" id="changeform" method="post" action="process_bug.cgi">

  <input type="hidden" name="delta_ts" value="2011-03-23 15:00:43">
  <input type="hidden" name="longdesclength" value="6">
  <input type="hidden" name="id" value="282">
  <input type="hidden" name="token" value="1492731577-hWOVWrK-vfwrQQDlyAABbfDv1GKp4J4GWpnvtAd3F6E">
<div class="bz_alias_short_desc_container edit_form">
     <a href="282.html"><b>Bug&nbsp;282</b></a> -<span id="summary_alias_container" class="bz_default_hidden"> 
      <span id="short_desc_nonedit_display">When quitting, Fiji does not prompt to save changes in non-image windows</span>
     </span>
  
       
    <div id="summary_alias_input">
      <table id="summary"> 
        <tr>
            <td colspan="2">
          </td>
        </tr>
        
        <tr><th class="field_label "
    id="field_label_short_desc">

    <label for="short_desc" accesskey="s">

  <a 
      title="The bug summary is a short sentence which succinctly describes what the bug is about."
      class="field_help_link"
  >Summary:</a>
</label>
</th>
          <td>When quitting, Fiji does not prompt to save changes in non-image windows
          </td>
        </tr>
      </table>
    </div>
  </div>
  
  <table class="edit_form">
    <tr>
      
      <td id="bz_show_bug_column_1" class="bz_show_bug_column">     
        <table>
          <tr>
    <th class="field_label">
      <a>Status</a>:
    </th>
    <td id="bz_field_status">
      <span id="static_bug_status">RESOLVED
          REMIND
      </span>
    </td>
  </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          <tr><th class="field_label "
    id="field_label_product">


  <a 
      title="Bugs are categorised into Products and Components."
      class="field_help_link"
  >Product:</a>

</th>
  <td class="field_value "
      id="field_container_product" >Fiji</td>
    </tr>

    
    <tr class="bz_default_hidden"><th class="field_label "
    id="field_label_classification">


  <a 
      title="Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation."
      class="field_help_link"
  >Classification:</a>

</th>
  <td class="field_value "
      id="field_container_classification" >Unclassified</td>
    </tr>
        
    
    
    <tr><th class="field_label "
    id="field_label_component">


  <a 
      title="Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list."
      class="field_help_link"
  >Component:</a>

</th>
  <td class="field_value "
      id="field_container_component" >ImageJ1</td>
    </tr>
    <tr><th class="field_label "
    id="field_label_version">

    <label for="version">

  <a 
      title="The version field defines the version of the software the bug was found in."
      class="field_help_link"
  >Version:</a>
</label>
</th>
        <td>unspecified
  </td>
    </tr>
        
    
        
    <tr><th class="field_label "
    id="field_label_rep_platform">

    <label for="rep_platform" accesskey="h">

  <a 
      title="The hardware platform the bug was observed on. Note: When searching, selecting the option &quot;All&quot; only finds bugs whose value for this field is literally the word &quot;All&quot;."
      class="field_help_link"
  >Hardware:</a>
</label>
</th>
      <td class="field_value">All
       All
      </td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          
          <tr>
      <th class="field_label">
        <label for="priority" accesskey="i">
          <a><u>I</u>mportance</a></label>:
      </th>
      <td>P2
       minor
      </td>
    </tr>            
          
          <tr>
      <th class="field_label">
        <a>Assigned To</a>:
      </th>
      <td><span class="vcard"><span class="fn">ImageJ Bugs Mailing List</span>
</span>
      </td>
    </tr>

    
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          <tr><th class="field_label "
    id="field_label_bug_file_loc">

    <label for="bug_file_loc" accesskey="u">

  <a 
      title="Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen."
      class="field_help_link"
  >URL:</a>
</label>
</th>
    <td>
      <span id="bz_url_input_area">
      </span>
    </td>
  </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>

          
<tr><th class="field_label "
    id="field_label_dependson">


  <a 
      title="The bugs listed here must be resolved before this bug can be resolved."
      class="field_help_link"
  >Depends on:</a>

</th>

  <td>
    <span id="dependson_input_area">
    </span>
    
  </td>
  </tr>
  
  <tr><th class="field_label "
    id="field_label_blocked">


  <a 
      title="This bug must be resolved before the bugs listed in this field can be resolved."
      class="field_help_link"
  >Blocks:</a>

</th>

  <td>
    <span id="blocked_input_area">
    </span>
    
  </td>
  </tr>
        </table>
      </td>
      <td>
        <div class="bz_column_spacer">&nbsp;</div>
      </td>
      
      <td id="bz_show_bug_column_2" class="bz_show_bug_column">
        <table cellpadding="3" cellspacing="1">
        <tr>
    <th class="field_label">
      Reported:
    </th>
    <td>2011-02-04 05:17 CST by <span class="vcard"><span class="fn">Curtis Rueden</span>
</span>
    </td>
  </tr>
  
  <tr>
    <th class="field_label">
      Modified:
    </th>
    <td>2011-03-23 15:00 CDT 
    </td>
  
  </tr>
         <tr>
      <th class="field_label">
        <label for="newcc" accesskey="a">CC List:</label>
      </th>
      <td>0 
          users
        <div id="cc_edit_area">
          <br>
        </div>
      </td>
    </tr>
         <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
<tr><th class="field_label "
    id="field_label_see_also">


  <a 
      title="This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with a comma. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields."
      class="field_help_link"
  >See Also:</a>

</th>
  <td class="field_value "
      id="field_container_see_also" ></td>
    </tr> 
         
         <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
         
                

        </table>
      </td>
    </tr>
    <tr>
      <td colspan="3">
          <hr id="bz_top_half_spacer">
      </td>
    </tr>
  </table>

  <table id="bz_big_form_parts" cellspacing="0" cellpadding="0"><tr>
  <td>

    



  </td>
  <td>
  </td>
  </tr></table>

  
  <div id="comments">






<!-- This auto-sizes the comments and positions the collapse/expand links 
     to the right. -->
<table class="bz_comment_table" cellpadding="0" cellspacing="0"><tr>
<td>
<div id="c0" class="bz_comment bz_first_comment">

      <div class="bz_first_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c0">Description</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Curtis Rueden</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-02-04 05:17:04 CST
        </span>
      </div>



<pre class="bz_comment_text" >STEPS TO REPRODUCE

1) Start Fiji
2) Choose File &gt; New &gt; Script or File &gt; New &gt; Text Window
3) Type some text into the editor window that appears
4) Choose File &gt; Quit (Fiji &gt; Quit Fiji on Mac OS X works too)
5) Fiji will quit without prompting to save changes in the editor window

REASON FOR THE BEHAVIOR

1) Performing File &gt; Quit calls IJ.quit().

2) IJ.quit() calls IJ.getInstance().quit(), which in turns spawns a new thread that invokes ij.ImageJ.run().

3) The run method does the following:
  * Sets a &quot;quitting&quot; flag
  * Prompts &quot;Are you sure you want to quit?&quot; in certain circumstances (but none generally relevant to this issue)
  * Calls WindowManager.closeAllWindows(), and aborts if it returns false
  * Otherwise, performs various cleanup, then calls System.exit(0)

4) The closeAllWindows method does the following:
  * For each *image* window, aborts if that window refuses to close
    - When asked to close, an ImageWindow prompts the user if it has unsaved changes
    - If the user cancels, the ImageWindow declines to close
  * Signals the OK to quit if the &quot;quitting&quot; flag is true (which at this point, it always is)
  * Additional logic past that point is ignored in this case

So, the problem is that when quitting, *non*-image windows are never queried to ensure they are OK with being shut down. This holds for both the Fiji Script Editor and ImageJ's built-in Text Editor.

Further, even if the closeAllWindows method is modified to ignore the &quot;quitting&quot; flag and continue onward, testing non-image windows, there is still a problem: only ij.plugin.frame.PlugInFrame and ij.text.TextWindow objects are closed with close(). Everything else is closed with setVisible(false) and dispose(), with no recourse. And the aforementioned classes' close() methods also have no recourse to cancel anyway, since close() returns void.</pre>
    </div><div id="c1" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c1">Comment 1</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Johannes Schindelin</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-02-04 16:00:52 CST
        </span>
      </div>



<pre class="bz_comment_text" >There must be some check somewhere for non-image windows... When I have no script editor or other window open, clicking on the little &quot;x&quot; in the window bar of the main window does not result in a question &quot;Quit?&quot;, but when I have a script editor open, the question pops up.

This is the relevant part of the thread dump obtained via Ctrl+\ while the question is showing:

&quot;Quit&quot; prio=10 tid=0x09d5ac00 nid=0x6097 in Object.wait() [0x09a8e000]
   java.lang.Thread.State: WAITING (on object monitor)
	at java.lang.Object.wait(Native Method)
	at java.lang.Object.wait(Object.java:485)
	at java.awt.Dialog.show(Dialog.java:1109)
	- locked &lt;0x8029f9c0&gt; (a java.awt.Component$AWTTreeLock)
	at java.awt.Component.show(Component.java:1563)
	at java.awt.Component.setVisible(Component.java:1515)
	at java.awt.Window.setVisible(Window.java:842)
	at java.awt.Dialog.setVisible(Dialog.java:986)
	at ij.gui.GenericDialog.showDialog(GenericDialog.java:1021)
	at ij.ImageJ.run(ImageJ.java:707)
	at java.lang.Thread.run(Thread.java:662)

The funny thing is that for me, too, File&gt;Quit does not bother to ask. From looking at the code, it also has another subtle bug: when there are modified images, the user does not get the &quot;Are you sure you want to quit&quot; question to indicate that there might be unsaved scripts/macros.

Further debugging indicates that the only difference in <a href="http://pacific.mpi-cbg.de/ImageJ.java:703">http://pacific.mpi-cbg.de/ImageJ.java:703</a> between clicking the little &quot;X&quot; and File&gt;Quit is the value of windowClosed. When clicking the little &quot;X&quot;, windowClosed is set to true, most likely through <a href="http://pacific.mpi-cbg.de/ImageJ.java:533">http://pacific.mpi-cbg.de/ImageJ.java:533</a> (it is a little confusing to see doCommand(&quot;Quit&quot;); being called _before_ that assignment, but the reality is that doCommand() launches another thread that is not fast enough _not_ to catch the variable change).

I am sure there once was a good rationale for the differing behavior of the little &quot;x&quot; and File&gt;Quit, but I failed at imagining one :-)</pre>
    </div><div id="c2" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c2">Comment 2</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Wayne Rasband</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-02-04 20:42:01 CST
        </span>
      </div>



<pre class="bz_comment_text" >This is fixed for text (Editor) windows in the ImageJ 1.45a6 daily build. It could also be fixed for Script Editor windows if there were a close() method that ImageJ could call using reflection.

-wayne</pre>
    </div><div id="c3" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c3">Comment 3</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Johannes Schindelin</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-02-04 21:01:45 CST
        </span>
      </div>



<pre class="bz_comment_text" >I'd rather not prefer to special case things here and there when the result is inconsistency. For example, I cannot think of a good reason why File&gt;Quit and clicking the little 'x' should behave differently, because it violates the <a href="http://en.wikipedia.org/wiki/Principle_of_least_astonishment">http://en.wikipedia.org/wiki/Principle_of_least_astonishment</a>. But I'll keep on trying to think of one! :-)</pre>
    </div><div id="c4" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c4">Comment 4</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Johannes Schindelin</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-03-23 14:59:01 CDT
        </span>
      </div>



<pre class="bz_comment_text" >Maybe we should change ImageJA to make the click on the 'x' behave the same as File&gt;Quit...</pre>
    </div><div id="c5" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c5">Comment 5</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Albert Cardona</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-03-23 15:00:43 CDT
        </span>
      </div>



<pre class="bz_comment_text" >(In reply to <a href="#c4">comment #4</a>)
<span class="quote">&gt; Maybe we should change ImageJA to make the click on the 'x' behave the same as
&gt; File&gt;Quit...</span >


I second that.

</pre>
    </div>


  

</td>
<td>
</td>
</tr></table>
  </div>
        

</form>


</div>

</body>
</html>
