<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                      "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
  <head>
    <title>Bug 53 &ndash; TrakEM2 doesn't build under openjdk</title>

      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">


<link rel="Top" href="">

  


  
    
      

      
      



    
    <link href="../css/global.css"
          rel="alternate stylesheet" 
          title="Classic"><link href="../css/global.css" rel="stylesheet"
        type="text/css" ><link href="../css/bug.css" rel="stylesheet"
        type="text/css" >

    <link href="../css/dusk.css" rel="stylesheet"
        type="text/css" title="Dusk">

    

    

    


    


    

    
    
    
  </head>



  <body onload=""
        class=" bz_bug bz_status_RESOLVED bz_product_Fiji bz_component_TrakEM2 bz_bug_53 yui-skin-sam">



<div id="header">
<div id="banner">
  </div>

<table border="0" cellspacing="0" cellpadding="0" id="titles">
<tr>
    <td id="title">
      <p>Bugzilla &ndash; Bug&nbsp;53</p>
    </td>

    <td id="subtitle">
      <p class="subheader">TrakEM2 doesn't build under openjdk</p>
    </td>

    <td id="information">
      <p class="header_addl_info">Last modified: 2009-11-20 15:22:54 CST</p>
    </td>
</tr>
</table>


</div> 

<div id="bugzilla-body">


<form name="changeform" id="changeform" method="post" action="">

  <input type="hidden" name="delta_ts" value="2009-11-20 15:22:54">
  <input type="hidden" name="longdesclength" value="11">
  <input type="hidden" name="id" value="53">
  <input type="hidden" name="token" value="1492731473-aD3A2HA9qcgRb8NzX8MmYv0tgVo5_cdNLVZuE-KWlUk">
<div class="bz_alias_short_desc_container edit_form">
     <a href="53.html"><b>Bug&nbsp;53</b></a> -<span id="summary_alias_container" class="bz_default_hidden"> 
      <span id="short_desc_nonedit_display">TrakEM2 doesn't build under openjdk</span>
     </span>
  
       
    <div id="summary_alias_input">
      <table id="summary"> 
        <tr>
            <td colspan="2">
          </td>
        </tr>
        
        <tr><th class="field_label "
    id="field_label_short_desc">

    <label for="short_desc" accesskey="s">

  <a 
      title="The bug summary is a short sentence which succinctly describes what the bug is about."
      class="field_help_link"
  >Summary:</a>
</label>
</th>
          <td>TrakEM2 doesn't build under openjdk
          </td>
        </tr>
      </table>
    </div>
  </div>
  
  <table class="edit_form">
    <tr>
      
      <td id="bz_show_bug_column_1" class="bz_show_bug_column">     
        <table>
          <tr>
    <th class="field_label">
      <a>Status</a>:
    </th>
    <td id="bz_field_status">
      <span id="static_bug_status">RESOLVED
          FIXED
      </span>
    </td>
  </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          <tr><th class="field_label "
    id="field_label_product">


  <a 
      title="Bugs are categorised into Products and Components."
      class="field_help_link"
  >Product:</a>

</th>
  <td class="field_value "
      id="field_container_product" >Fiji</td>
    </tr>

    
    <tr class="bz_default_hidden"><th class="field_label "
    id="field_label_classification">


  <a 
      title="Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation."
      class="field_help_link"
  >Classification:</a>

</th>
  <td class="field_value "
      id="field_container_classification" >Unclassified</td>
    </tr>
        
    
    
    <tr><th class="field_label "
    id="field_label_component">


  <a 
      title="Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list."
      class="field_help_link"
  >Component:</a>

</th>
  <td class="field_value "
      id="field_container_component" >TrakEM2</td>
    </tr>
    <tr><th class="field_label "
    id="field_label_version">

    <label for="version">

  <a 
      title="The version field defines the version of the software the bug was found in."
      class="field_help_link"
  >Version:</a>
</label>
</th>
        <td>unspecified
  </td>
    </tr>
        
    
        
    <tr><th class="field_label "
    id="field_label_rep_platform">

    <label for="rep_platform" accesskey="h">

  <a 
      title="The hardware platform the bug was observed on. Note: When searching, selecting the option &quot;All&quot; only finds bugs whose value for this field is literally the word &quot;All&quot;."
      class="field_help_link"
  >Hardware:</a>
</label>
</th>
      <td class="field_value">PC
       Linux
      </td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          
          <tr>
      <th class="field_label">
        <label for="priority" accesskey="i">
          <a><u>I</u>mportance</a></label>:
      </th>
      <td>P2
       normal
      </td>
    </tr>            
          
          <tr>
      <th class="field_label">
        <a>Assigned To</a>:
      </th>
      <td><span class="vcard"><span class="fn">Albert Cardona</span>
</span>
      </td>
    </tr>

    
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          <tr><th class="field_label "
    id="field_label_bug_file_loc">

    <label for="bug_file_loc" accesskey="u">

  <a 
      title="Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen."
      class="field_help_link"
  >URL:</a>
</label>
</th>
    <td>
      <span id="bz_url_input_area">
      </span>
    </td>
  </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>

          
<tr><th class="field_label "
    id="field_label_dependson">


  <a 
      title="The bugs listed here must be resolved before this bug can be resolved."
      class="field_help_link"
  >Depends on:</a>

</th>

  <td>
    <span id="dependson_input_area">
    </span>
    
  </td>
  </tr>
  
  <tr><th class="field_label "
    id="field_label_blocked">


  <a 
      title="This bug must be resolved before the bugs listed in this field can be resolved."
      class="field_help_link"
  >Blocks:</a>

</th>

  <td>
    <span id="blocked_input_area">
    </span>
    
  </td>
  </tr>
        </table>
      </td>
      <td>
        <div class="bz_column_spacer">&nbsp;</div>
      </td>
      
      <td id="bz_show_bug_column_2" class="bz_show_bug_column">
        <table cellpadding="3" cellspacing="1">
        <tr>
    <th class="field_label">
      Reported:
    </th>
    <td>2009-05-01 09:48 CDT by <span class="vcard"><span class="fn">Mark Longair</span>
</span>
    </td>
  </tr>
  
  <tr>
    <th class="field_label">
      Modified:
    </th>
    <td>2009-11-20 15:22 CST 
    </td>
  
  </tr>
         <tr>
      <th class="field_label">
        <label for="newcc" accesskey="a">CC List:</label>
      </th>
      <td>1 
          user
          <span id="cc_edit_area_showhide_container" class="bz_default_hidden">
            (<a href="#" id="cc_edit_area_showhide">show</a>)
          </span>
        <div id="cc_edit_area">
          <br>
            <select id="cc" multiple="multiple" size="5">
                <option value="johannes.schindelin">johannes.schindelin</option>
            </select>
        </div>
          
      </td>
    </tr>
         <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
<tr><th class="field_label "
    id="field_label_see_also">


  <a 
      title="This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with a comma. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields."
      class="field_help_link"
  >See Also:</a>

</th>
  <td class="field_value "
      id="field_container_see_also" ></td>
    </tr> 
         
         <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
         
                

        </table>
      </td>
    </tr>
    <tr>
      <td colspan="3">
          <hr id="bz_top_half_spacer">
      </td>
    </tr>
  </table>

  <table id="bz_big_form_parts" cellspacing="0" cellpadding="0"><tr>
  <td>

    



  </td>
  <td>
  </td>
  </tr></table>

  
  <div id="comments">






<!-- This auto-sizes the comments and positions the collapse/expand links 
     to the right. -->
<table class="bz_comment_table" cellpadding="0" cellspacing="0"><tr>
<td>
<div id="c0" class="bz_comment bz_first_comment">

      <div class="bz_first_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c0">Description</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Mark Longair</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2009-05-01 09:48:52 CDT
        </span>
      </div>



<pre class="bz_comment_text" >TrakEM2 builds successfully under openjdk apart from
ini/trakem2/io/ImageSaver.java - the JPEG encoding here
could be replaced by ImageIO as with 52eb5b6f0f9 in
ImageJ.  These errors and those in ImageJ (<a class="bz_bug_link 
          bz_status_RESOLVED  bz_closed"
   title="RESOLVED FIXED - ImageJA doesn't build under openjdk"
   href="52.html">Bug 52</a>) are
the only ones stopping Fiji from building under openjdk
at the moment.

 JAVA_HOME=/usr/lib/jvm/java-6-openjdk/ make
sh Build.sh run
Building plugins/TrakEM2_.jar &lt;- ij.jar plugins/VIB_.jar plugins/m...
Building in TrakEM2/
Building TrakEM2_.jar &lt;- ini/trakem2/Open_Project.java ini/trakem2...
./TrakEM2/ini/trakem2/io/ImageSaver.java:116: warning: com.sun.image.codec.jpeg.JPEGImageEncoder is Sun proprietary API and may be removed in a future release
			final JPEGImageEncoder encoder = JPEGCodec.createJPEGEncoder(f);
			      ^
./TrakEM2/ini/trakem2/io/ImageSaver.java:116: warning: com.sun.image.codec.jpeg.JPEGCodec is Sun proprietary API and may be removed in a future release
			final JPEGImageEncoder encoder = JPEGCodec.createJPEGEncoder(f);
			                                 ^
./TrakEM2/ini/trakem2/io/ImageSaver.java:117: warning: com.sun.image.codec.jpeg.JPEGEncodeParam is Sun proprietary API and may be removed in a future release
			final JPEGEncodeParam param = as_grey ? encoder.getDefaultJPEGEncodeParam(bi.getRaster(), JPEGDecodeParam.COLOR_ID_GRAY)
			      ^
./TrakEM2/ini/trakem2/io/ImageSaver.java:117: warning: com.sun.image.codec.jpeg.JPEGDecodeParam is Sun proprietary API and may be removed in a future release
			final JPEGEncodeParam param = as_grey ? encoder.getDefaultJPEGEncodeParam(bi.getRaster(), JPEGDecodeParam.COLOR_ID_GRAY)
			                                                                                          ^
./TrakEM2/ini/trakem2/io/ImageSaver.java:117: getDefaultJPEGEncodeParam(java.awt.image.BufferedImage) in com.sun.image.codec.jpeg.JPEGImageEncoder cannot be applied to (java.awt.image.WritableRaster,int)
			final JPEGEncodeParam param = as_grey ? encoder.getDefaultJPEGEncodeParam(bi.getRaster(), JPEGDecodeParam.COLOR_ID_GRAY)
			                                               ^
./TrakEM2/ini/trakem2/io/ImageSaver.java:136: warning: com.sun.image.codec.jpeg.JPEGDecodeParam is Sun proprietary API and may be removed in a future release
		return openJpeg(path, JPEGDecodeParam.COLOR_ID_GRAY);
		                      ^
./TrakEM2/ini/trakem2/io/ImageSaver.java:209: warning: com.sun.image.codec.jpeg.JPEGCodec is Sun proprietary API and may be removed in a future release
		return JPEGCodec.createJPEGDecoder(stream, JPEGCodec.getDefaultJPEGEncodeParam(1, color_id)).decodeAsBufferedImage();
		                                           ^
./TrakEM2/ini/trakem2/io/ImageSaver.java:209: warning: com.sun.image.codec.jpeg.JPEGCodec is Sun proprietary API and may be removed in a future release
		return JPEGCodec.createJPEGDecoder(stream, JPEGCodec.getDefaultJPEGEncodeParam(1, color_id)).decodeAsBufferedImage();
		       ^
./TrakEM2/ini/trakem2/io/ImageSaver.java:209: cannot find symbol
symbol  : method createJPEGDecoder(java.io.InputStream,com.sun.image.codec.jpeg.JPEGEncodeParam)
location: class com.sun.image.codec.jpeg.JPEGCodec
		return JPEGCodec.createJPEGDecoder(stream, JPEGCodec.getDefaultJPEGEncodeParam(1, color_id)).decodeAsBufferedImage();
		                ^
Note: Some input files use or override a deprecated API.
Note: Recompile with -Xlint:deprecation for details.
Note: Some input files use unchecked or unsafe operations.
Note: Recompile with -Xlint:unchecked for details.
2 errors
7 warnings
Fake failed: Compile error
	in rule TrakEM2_.jar &lt;- ini/trakem2/Open_Project.java ini/trakem2...
	in rule all &lt;- TrakEM2_.jar
	in rule plugins/TrakEM2_.jar &lt;- ij.jar plugins/VIB_.jar plugins/m...
	in rule all &lt;- fiji ij.jar plugins/loci_tools.jar plugins/VIB_.ja...
	in rule run &lt;- all run-fiji
	in rule  &lt;- run
make: *** [run] Error 1</pre>
    </div><div id="c1" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c1">Comment 1</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Albert Cardona</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2009-05-05 15:07:15 CDT
        </span>
      </div>



<pre class="bz_comment_text" >The ini.trakem2.io.ImageSaver class uses the old com.sun.image.codec.jpeg.JPEGCode classes. Unfortunately, there isn't a one-to-one correspondence between these and the new java.io.ImageIO library.
TrakEM2 is very sensitive to jpeg file generation, and uses three types:

A - grey jpegs (single channel)
B - color jpegs (RGB, which get compressed to 2 channels in jpeg image)
C - color jpegs with alpha (RGBA, which I have no idea how are they compressed)

The last, C, is already compressed and read using ImageIO.

If anybody knows how to reliably create types A and B of jpegs using ImageIO, please let me know. Patches welcome.</pre>
    </div><div id="c2" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c2">Comment 2</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Mark Longair</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2009-05-05 17:46:38 CDT
        </span>
      </div>



<pre class="bz_comment_text" >To generate A, you should be able to just use BufferedImage.TYPE_BYTE_GRAY
when creating the BufferedImage that you write out.  The same should work
with other image types, although of course alpha channels don't necessarily
work well with JPEG anyway. [1]

Sorry, I'm afraid don't have time to work on a patch at the moment myself :(

[1] <a href="http://www.faqs.org/faqs/jpeg-faq/part1/section-12.html">http://www.faqs.org/faqs/jpeg-faq/part1/section-12.html</a> which I guess
you know about anyway, but just in case...</pre>
    </div><div id="c3" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c3">Comment 3</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Mark Longair</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2009-09-29 21:11:56 CDT
        </span>
      </div>



<pre class="bz_comment_text" >I've pushed a branch of TrakEM2 called openjdk-jpeg2 which builds under OpenJDK (6b14-1.4.1-0ubuntu11) for me [1]:

  <a href="http://repo.or.cz/w/trakem2.git?a=log;h=refs/heads/openjdk-jpeg2">http://repo.or.cz/w/trakem2.git?a=log;h=refs/heads/openjdk-jpeg2</a>

I haven't had much success in testing this, since I'm having trouble getting TrakEM2 to work in the current version, but I thought I should push it anyway so you can try it out under openjdk-6-* and sun-java6-*.  As I mentioned in IRC, testDebugAlpha() doesn't seem to work under OpenJDK but presumably still works under Sun Java 6, since that code path is unchanged.

The key thing, I think, is to check that this doesn't cause any regressions under Sun Java 6 - we can always add warnings about features that may not work due to current bugs or missing features in OpenJDK.

[1] Built without any of the java/ submodules and with &quot;JAVA_HOME=/usr/lib/jvm/java-6-openjdk/ make&quot;</pre>
    </div><div id="c4" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c4">Comment 4</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Johannes Schindelin</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2009-11-12 00:50:39 CST
        </span>
      </div>



<pre class="bz_comment_text" >Albert, does Mark's work fix the issue?  I see that you did not merge it into TrakEM2 yet.  This is probably a major show-stopper for Fiji's Ubuntu packaging.</pre>
    </div><div id="c5" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c5">Comment 5</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Mark Longair</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2009-11-16 19:44:32 CST
        </span>
      </div>



<pre class="bz_comment_text" >Just to confirm, I do need to have an answer about #3 before putting up the
up-do-date packages, which depend on openjdk-6-jdk instead of the sun-java6
versions...</pre>
    </div><div id="c6" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c6">Comment 6</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Albert Cardona</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2009-11-16 23:56:55 CST
        </span>
      </div>



<pre class="bz_comment_text" >Mark, to move forward with this bug, I need someone to test:

Add an 8-bit gray, and 8-bit with lut,
an 8-bit color, a 16-bit gray, a 16-bit with lut, a 32-bit gray, a
32-bit with lut, and an RGB, to a TrakEM2 canvas. Then do it again and
add an alpha mask to each image. Observe how the images render on the
canvas. To be fair, use min/max ranges other than 0,255 for all images. Use high min/max ranges for 16-bit and 32-bit images.

Now merge your changes and make a new trakem2 project and repeat all,
with sun-java. See that everything looks exactly the same---if so, then all is OK.

I have no time for all this.</pre>
    </div><div id="c7" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c7">Comment 7</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Albert Cardona</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2009-11-19 20:04:52 CST
        </span>
      </div>



<pre class="bz_comment_text" >Mark,
According to your own commit, it says:

&quot;An (as yet largely untested) patch to let TrakEM2 build...&quot;

The situation is the following: the jpeg storage of TrakEM2 is a core function of TrakEM2 that has to &quot;just work&quot;, not &quot;maybe&quot;. Your patch cannot be accepted into master without testing. Please test and then merge; meanwhile, please revert the commit.</pre>
    </div><div id="c8" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c8">Comment 8</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Mark Longair</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2009-11-19 21:15:07 CST
        </span>
      </div>



<pre class="bz_comment_text" >(In reply to <a href="#c7">comment #7</a>)
<span class="quote">&gt; Mark,
&gt; According to your own commit, it says:
&gt; 
&gt; &quot;An (as yet largely untested) patch to let TrakEM2 build...&quot;
&gt; 
&gt; The situation is the following: the jpeg storage of TrakEM2 is a core function
&gt; of TrakEM2 that has to &quot;just work&quot;, not &quot;maybe&quot;. Your patch cannot be accepted
&gt; into master without testing. Please test and then merge; meanwhile, please
&gt; revert the commit.</span >

I should have altered the commit message before pushing it, but it has been
tested now, at least in the way you asked for.  The situation (see IRC logs
for today) is that Johannes did the test above that you asked for above and
confirmed that the behaviour was the same when using sun-java6.

I've reverted it anyway, but I had assumed that since you said &quot;if so, then
all is OK&quot; then having passed that test it was fine.</pre>
    </div><div id="c9" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c9">Comment 9</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Johannes Schindelin</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2009-11-20 01:05:31 CST
        </span>
      </div>



<pre class="bz_comment_text" >Please revert the revert, otherwise my time to do the tests was spent in vain.  Yes, I left the original commit message, but on purpose: it serves as a reminder that the main authors of TrakEM2 did not yet have time to test properly, but the footer states (quite clearly!) that it was tested in the requested way!!!</pre>
    </div><div id="c10" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c10">Comment 10</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Albert Cardona</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2009-11-20 15:22:54 CST
        </span>
      </div>



<pre class="bz_comment_text" >This &quot;bug&quot; is now finally fixed, after adding a number of fixes to ImageSaver--the most important, a native memory leak (aka lack of flushing a BufferedImage).

Thanks Mark and Johannes for all the work!</pre>
    </div>


  

</td>
<td>
</td>
</tr></table>
  </div>
        

</form>


</div>

</body>
</html>
