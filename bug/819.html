<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                      "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
  <head>
    <title>Bug 819 &ndash; Clean Garbage command is not freeing memory during macro</title>

      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">


<link rel="Top" href="">

  


  
    
      

      
      



    
    <link href="../css/global.css"
          rel="alternate stylesheet" 
          title="Classic"><link href="../css/global.css" rel="stylesheet"
        type="text/css" ><link href="../css/bug.css" rel="stylesheet"
        type="text/css" >

    <link href="../css/dusk.css" rel="stylesheet"
        type="text/css" title="Dusk">

    

    

    


    


    

    
    
    
  </head>



  <body onload=""
        class=" bz_bug bz_status_RESOLVED bz_product_Fiji bz_component_Plugins bz_bug_819 yui-skin-sam">



<div id="header">
<div id="banner">
  </div>

<table border="0" cellspacing="0" cellpadding="0" id="titles">
<tr>
    <td id="title">
      <p>Bugzilla &ndash; Bug&nbsp;819</p>
    </td>

    <td id="subtitle">
      <p class="subheader">Clean Garbage command is not freeing memory during macro</p>
    </td>

    <td id="information">
      <p class="header_addl_info">Last modified: 2014-08-08 14:55:08 CDT</p>
    </td>
</tr>
</table>


</div> 

<div id="notice">
  <table>
    <tr>
      <td style="font-size: 72px; color: firebrick; padding: 0 10px 0 10px">&#9888;</td>
      <td>
        <p style="margin: 0.4em">
        NOTICE! This is a static HTML version of a legacy Fiji BugZilla bug.
        </p>
        <p style="margin: 0.4em">
        The Fiji project now
        <a href="https://imagej.net/Issues">uses GitHub Issues</a> for issue tracking.
        </p>
        <p style="margin: 0.4em">
        Please
        <a href="https://github.com/fiji/fiji/issues/new">file all new issues</a>
        there.
        </p>
      </td>
    </tr>
  </table>
</div>

<div id="bugzilla-body">


<form name="changeform" id="changeform" method="post" action="">

  <input type="hidden" name="delta_ts" value="2014-08-08 14:55:08">
  <input type="hidden" name="longdesclength" value="13">
  <input type="hidden" name="id" value="819">
  <input type="hidden" name="token" value="1492731804-rveTj5JVlFxvyuD8m3A3yqwhofwZIq9mq7C-U0a3zjM">
<div class="bz_alias_short_desc_container edit_form">
     <a href="819.html"><b>Bug&nbsp;819</b></a> -<span id="summary_alias_container" class="bz_default_hidden"> 
      <span id="short_desc_nonedit_display">Clean Garbage command is not freeing memory during macro</span>
     </span>
  
       
    <div id="summary_alias_input">
      <table id="summary"> 
        <tr>
            <td colspan="2">
          </td>
        </tr>
        
        <tr><th class="field_label "
    id="field_label_short_desc">

    <label for="short_desc" accesskey="s">

  <a 
      title="The bug summary is a short sentence which succinctly describes what the bug is about."
      class="field_help_link"
  >Summary:</a>
</label>
</th>
          <td>Clean Garbage command is not freeing memory during macro
          </td>
        </tr>
      </table>
    </div>
  </div>
  
  <table class="edit_form">
    <tr>
      
      <td id="bz_show_bug_column_1" class="bz_show_bug_column">     
        <table>
          <tr>
    <th class="field_label">
      <a>Status</a>:
    </th>
    <td id="bz_field_status">
      <span id="static_bug_status">RESOLVED
          FIXED
      </span>
    </td>
  </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          <tr><th class="field_label "
    id="field_label_product">


  <a 
      title="Bugs are categorised into Products and Components."
      class="field_help_link"
  >Product:</a>

</th>
  <td class="field_value "
      id="field_container_product" >Fiji</td>
    </tr>

    
    <tr class="bz_default_hidden"><th class="field_label "
    id="field_label_classification">


  <a 
      title="Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation."
      class="field_help_link"
  >Classification:</a>

</th>
  <td class="field_value "
      id="field_container_classification" >Unclassified</td>
    </tr>
        
    
    
    <tr><th class="field_label "
    id="field_label_component">


  <a 
      title="Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list."
      class="field_help_link"
  >Component:</a>

</th>
  <td class="field_value "
      id="field_container_component" >Plugins</td>
    </tr>
    <tr><th class="field_label "
    id="field_label_version">

    <label for="version">

  <a 
      title="The version field defines the version of the software the bug was found in."
      class="field_help_link"
  >Version:</a>
</label>
</th>
        <td>unspecified
  </td>
    </tr>
        
    
        
    <tr><th class="field_label "
    id="field_label_rep_platform">

    <label for="rep_platform" accesskey="h">

  <a 
      title="The hardware platform the bug was observed on. Note: When searching, selecting the option &quot;All&quot; only finds bugs whose value for this field is literally the word &quot;All&quot;."
      class="field_help_link"
  >Hardware:</a>
</label>
</th>
      <td class="field_value">PC
       Windows
      </td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          
          <tr>
      <th class="field_label">
        <label for="priority" accesskey="i">
          <a><u>I</u>mportance</a></label>:
      </th>
      <td>P4
       normal
      </td>
    </tr>            
          
          <tr>
      <th class="field_label">
        <a>Assigned To</a>:
      </th>
      <td><span class="vcard"><span class="fn">ImageJ Bugs Mailing List</span>
</span>
      </td>
    </tr>

    
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          <tr><th class="field_label "
    id="field_label_bug_file_loc">

    <label for="bug_file_loc" accesskey="u">

  <a 
      title="Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen."
      class="field_help_link"
  >URL:</a>
</label>
</th>
    <td>
      <span id="bz_url_input_area">
      </span>
    </td>
  </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>

          <tr>
    <th class="field_label">
      <label for="duplicates">Duplicates</label>:
    </th>
    <td class="field_value" colspan="2">
      <span id="duplicates"><a class="bz_bug_link 
          bz_status_RESOLVED  bz_closed"
   title="RESOLVED DUPLICATE - Very slow opening images and Memory leak"
   href="863.html">863</a> <a class="bz_bug_link 
          bz_status_RESOLVED  bz_closed"
   title="RESOLVED DUPLICATE - Error in file naming when re-opening files"
   href="884.html">884</a> 
      </span>
    </td>
  </tr>
<tr><th class="field_label "
    id="field_label_dependson">


  <a 
      title="The bugs listed here must be resolved before this bug can be resolved."
      class="field_help_link"
  >Depends on:</a>

</th>

  <td>
    <span id="dependson_input_area">
    </span>
    
  </td>
  </tr>
  
  <tr><th class="field_label "
    id="field_label_blocked">


  <a 
      title="This bug must be resolved before the bugs listed in this field can be resolved."
      class="field_help_link"
  >Blocks:</a>

</th>

  <td>
    <span id="blocked_input_area">
    </span>
    
  </td>
  </tr>
        </table>
      </td>
      <td>
        <div class="bz_column_spacer">&nbsp;</div>
      </td>
      
      <td id="bz_show_bug_column_2" class="bz_show_bug_column">
        <table cellpadding="3" cellspacing="1">
        <tr>
    <th class="field_label">
      Reported:
    </th>
    <td>2014-06-25 13:21 CDT by <span class="vcard">amc910
</span>
    </td>
  </tr>
  
  <tr>
    <th class="field_label">
      Modified:
    </th>
    <td>2014-08-08 14:55 CDT 
    </td>
  
  </tr>
         <tr>
      <th class="field_label">
        <label for="newcc" accesskey="a">CC List:</label>
      </th>
      <td>7 
          users
          <span id="cc_edit_area_showhide_container" class="bz_default_hidden">
            (<a href="#" id="cc_edit_area_showhide">show</a>)
          </span>
        <div id="cc_edit_area">
          <br>
            <select id="cc" multiple="multiple" size="5">
                <option value="amc910">amc910</option>
                <option value="ctrueden">ctrueden</option>
                <option value="hinerm">hinerm</option>
                <option value="jgburchfield.au">jgburchfield.au</option>
                <option value="johannes.schindelin">johannes.schindelin</option>
                <option value="nevermore78">nevermore78</option>
                <option value="wsr">wsr</option>
            </select>
        </div>
          
      </td>
    </tr>
         <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
<tr><th class="field_label "
    id="field_label_see_also">


  <a 
      title="This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with a comma. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields."
      class="field_help_link"
  >See Also:</a>

</th>
  <td class="field_value "
      id="field_container_see_also" ></td>
    </tr> 
         
         <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
         
                

        </table>
      </td>
    </tr>
    <tr>
      <td colspan="3">
          <hr id="bz_top_half_spacer">
      </td>
    </tr>
  </table>

  <table id="bz_big_form_parts" cellspacing="0" cellpadding="0"><tr>
  <td>

    



  </td>
  <td>
  </td>
  </tr></table>

  
  <div id="comments">






<!-- This auto-sizes the comments and positions the collapse/expand links 
     to the right. -->
<table class="bz_comment_table" cellpadding="0" cellspacing="0"><tr>
<td>
<div id="c0" class="bz_comment bz_first_comment">

      <div class="bz_first_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c0">Description</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard">amc910
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-06-25 13:21:00 CDT
        </span>
      </div>



<pre class="bz_comment_text" >Hi there,

I'm running a macro (included below) to create a montage of images from separate folders.
The macro iterates over 24 folders, opening the nth image from each in Fiji (the 21st and 23rd image run were saved with a different naming format, hence the 'if'). It then turns these images into a stack, before making a 5x5 montage of the images, saving this montage, and then closing both the stack and the montage. It then does the same for the n+1th image, and so on.

The issue is that this macro seems to be causing Fiji's memoy to run out after ~ 30-40 loops (montages).
The Collect Garbage command doesn't seem to release this memory. It's also not being released when Fiji is closed, an imageJ service remains running in the Task Manager with ~13,000,000k Memory, which I need to stop manually.

If you need any more information, let me know.

Also, if there's a simpler way to run my macro than I'm using, I'd love to hear it.

Kind regards,
Angus


for(image=1; image&lt;=349; image++){
	for(drop=1; drop&lt;=24; drop++){
		if(drop==21 || drop==23){
			open(&quot;F:\\Timelapse\\GlassReg\\GlassShards3\\&quot;+drop+&quot;\\&quot;+IJ.pad(image,3)+&quot;.tif&quot;);
			}
		else{
			open(&quot;F:\\Timelapse\\GlassReg\\GlassShards3\\&quot;+drop+&quot;\\&quot;+IJ.pad(image,5)+&quot;.tif&quot;);
			}
	}
	run(&quot;Images to Stack&quot;, &quot;name=Filler title=[] use&quot;);
	run(&quot;Make Montage...&quot;, &quot;columns=5 rows=5 scale=1 first=1 last=24 	increment=1 border=0 font=12&quot;);
	run(&quot;Save&quot;, &quot;save=F:\\Timelapse\\GlassReg\\Full\\&quot; + image + &quot;.tif&quot;);
	run(&quot;Close&quot;);
	run(&quot;Close&quot;);
	run(&quot;Collect Garbage&quot;);
	}

Information about your version of Java:

  os.arch =&gt; amd64
  os.name =&gt; Windows 7
  os.version =&gt; 6.1
  java.version =&gt; 1.6.0_24
  java.vendor =&gt; Sun Microsystems Inc.
  java.runtime.name =&gt; Java(TM) SE Runtime Environment
  java.runtime.version =&gt; 1.6.0_24-b07
  java.vm.name =&gt; Java HotSpot(TM) 64-Bit Server VM
  java.vm.version =&gt; 19.1-b02
  java.vm.vendor =&gt; Sun Microsystems Inc.
  java.vm.info =&gt; mixed mode
  java.awt.graphicsenv =&gt; sun.awt.Win32GraphicsEnvironment
  java.specification.name =&gt; Java Platform API Specification
  java.specification.version =&gt; 1.6
  sun.cpu.endian =&gt; little
  sun.desktop =&gt; windows
  file.separator =&gt; \

The up-to-date check says: UP_TO_DATE

Information relevant to JAVA_HOME related problems:

  JAVA_HOME is set to: C:\FIJI\Fiji.app/java/win64/jdk1.6.0_24//jre
  imagej.dir =&gt; C:\FIJI\Fiji.app

Information about the version of each plugin:

Activated update sites:
ImageJ: <a href="http://update.imagej.net/">http://update.imagej.net/</a> (last check:20140623212553)
Fiji: <a href="http://fiji.sc/update/">http://fiji.sc/update/</a> (last check:20140623232555)

Files not up-to-date:
  035497e9 (LOCAL_ONLY) 20140625191733 macros/Timelapse1.ijm</pre>
    </div><div id="c1" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c1">Comment 1</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Wayne Rasband</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-06-25 13:45:34 CDT
        </span>
      </div>



<pre class="bz_comment_text" >The macro is opening at least three images but only closing two. Try replacing

   run(&quot;Close&quot;);
   run(&quot;Close&quot;);
   run(&quot;Collect Garbage&quot;);

with

   run(&quot;Close All&quot;);</pre>
    </div><div id="c2" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c2">Comment 2</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Curtis Rueden</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-06-25 13:48:38 CDT
        </span>
      </div>



<pre class="bz_comment_text" >Angus, please give Wayne's suggestion a try and let us know how it goes.</pre>
    </div><div id="c3" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c3">Comment 3</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard">amc910
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-06-25 14:08:46 CDT
        </span>
      </div>



<pre class="bz_comment_text" >I've changed the macro accordingly and am running it again now. Looking at Task Manager the ImageJ process memory is still creeping up as the macro loops.
The memory monitor on Fiji itself also seems to be increasing, when it pops up on the status bar.

It will take a little while (30 minutes or so) to verify that this memory increase will eventually halt the macro again, but it looks like it's doing the same things as before.

Cheers,
Angus</pre>
    </div><div id="c4" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c4">Comment 4</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Curtis Rueden</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-06-25 14:25:47 CDT
        </span>
      </div>



<pre class="bz_comment_text" >Note that the Task Manager will not accurately report how much memory ImageJ is actually using at the moment. See this FAQ entry on the ImageJ wiki:

 <a href="http://wiki.imagej.net/Frequently_Asked_Questions#Why_does_ImageJ_not_release_any_memory_back_to_the_system.3F">http://wiki.imagej.net/Frequently_Asked_Questions#Why_does_ImageJ_not_release_any_memory_back_to_the_system.3F</a>

But ImageJ's &quot;Monitor Memory&quot; command is good to watch. If it continually increases without dropping, even when you click on the status bar (which triggers a garbage collection), that may indicate a memory issue.</pre>
    </div><div id="c5" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c5">Comment 5</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard">amc910
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-06-25 15:00:24 CDT
        </span>
      </div>



<pre class="bz_comment_text" >To update, Fiji has indeed run out of memory, and the macro has been aborted.
I tried clicking the status bar while the macro was running, as well as activating a Cleanup Garbage command through the menu system, but neither seemed to do anything.

Ang</pre>
    </div><div id="c6" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c6">Comment 6</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Johannes Schindelin</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-06-25 16:18:09 CDT
        </span>
      </div>



<pre class="bz_comment_text" >There are a couple of things you can do to diagnose what keeps those references to allocated memory... You could give JVisualVM a try, see <a href="http://fiji.sc/Debugging#Debugging_memory_leaks">http://fiji.sc/Debugging#Debugging_memory_leaks</a></pre>
    </div><div id="c7" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c7">Comment 7</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Wayne Rasband</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-06-25 21:31:35 CDT
        </span>
      </div>



<pre class="bz_comment_text" >This appears to be SCIFIO bug. After running the following macro with &quot;Use SCIFIO when opening files&quot; checked in Edit&gt;Options&gt;ImageJ2 there is 1218MB allocated, which cannot be reclaimed by clicking in the status bar or in the &quot;Memory&quot; window. After running the macro with &quot;Use SCIFIO when opening files&quot; unchecked there is 12MB allocated after memory is reclaimed. I also noticed that the macro runs 6 times slower when &quot;Use SCIFIO when opening files&quot; is checked.

  setBatchMode(true);
  newImage(&quot;Untitled&quot;, &quot;8-bit ramp&quot;, 1024, 1024, 1);
  dir = getDirectory(&quot;temp&quot;);
  saveAs(&quot;tif&quot;, dir+&quot;temp.tif&quot;);
  close;
  for(image=1; image&lt;=10; image++) {
     for(drop=1; drop&lt;=24; drop++)
        open(dir+&quot;temp.tif&quot;);
     run(&quot;Images to Stack&quot;, &quot;name=Filler title=[] use&quot;);
     run(&quot;Make Montage...&quot;, &quot;columns=5 rows=5 scale=1 first=1 last=24 increment=1 border=0 font=12&quot;);
     saveAs(&quot;tif&quot;, dir+&quot;temp2.tif&quot;);
     run(&quot;Close All&quot;);
  }
  ok = File.delete(dir+&quot;temp.tif&quot;)
  ok = File.delete(dir+&quot;temp2.tif&quot;)</pre>
    </div><div id="c8" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c8">Comment 8</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard">amc910
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-06-26 03:45:24 CDT
        </span>
      </div>



<pre class="bz_comment_text" >Morning everyone,

I've disabled SCIFIO and have run the macro again, and all issues seem to have been dealt with.
Memory is correctly being re-used at the end of each loop.
In addition, the time for a loop to run has reduced dramatically, from ~2 minutes per montage to ~10 seconds! (this was all in the time taken to open up the images before converting to a stack. Both the stack and montage commands were very quick).

I consider this issue solved on my end. I hope letting you know about this bug was useful.

Thank you everyone,
Angus</pre>
    </div><div id="c9" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c9">Comment 9</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Mark Hiner</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-07-22 08:17:52 CDT
        </span>
      </div>



<pre class="bz_comment_text" >Sorry for not linking this earlier, but there is a confirmed bug on the SCIFIO/ImageJ2 side, specifically with the legacy layer:

<a href="https://github.com/imagej/imagej-legacy/issues/67">https://github.com/imagej/imagej-legacy/issues/67</a>

This is leading to undesirable hard references to images that do not get cleaned up when an ImagePlus is closed... so there is a true memory leak.</pre>
    </div><div id="c10" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c10">Comment 10</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Mark Hiner</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-07-22 08:21:19 CDT
        </span>
      </div>



<pre class="bz_comment_text" >*** <a class="bz_bug_link 
          bz_status_RESOLVED  bz_closed"
   title="RESOLVED DUPLICATE - Very slow opening images and Memory leak"
   href="863.html">Bug 863</a> has been marked as a duplicate of this bug. ***</pre>
    </div><div id="c11" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c11">Comment 11</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Mark Hiner</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-08-07 10:36:28 CDT
        </span>
      </div>



<pre class="bz_comment_text" >*** <a class="bz_bug_link 
          bz_status_RESOLVED  bz_closed"
   title="RESOLVED DUPLICATE - Error in file naming when re-opening files"
   href="884.html">Bug 884</a> has been marked as a duplicate of this bug. ***</pre>
    </div><div id="c12" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c12">Comment 12</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Mark Hiner</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-08-08 14:55:08 CDT
        </span>
      </div>



<pre class="bz_comment_text" >This should be fixed in the latest Fiji (imagej 2.0.0-rc-10)</pre>
    </div>


  

</td>
<td>
</td>
</tr></table>
  </div>
        

</form>


</div>

</body>
</html>
